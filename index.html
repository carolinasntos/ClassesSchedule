<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Horario desde Imagen</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; display: flex; gap: 20px; margin: 20px; }
    #materias { width: 300px; }
    #calendar { flex: 1; }
    .materia { padding: 8px; margin: 5px 0; background: #f5f5f5; border: 1px solid #ddd; cursor: grab; }
  </style>
</head>
<body>
  <div id="materias">
    <h2>Materias detectadas</h2>
    <input type="file" id="fileInput" accept="image/*">
    <div id="materias-list"></div>
  </div>

  <div id="calendar"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const materiasList = document.getElementById('materias-list');
    let calendar;

    document.addEventListener('DOMContentLoaded', () => {
      calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'timeGridWeek',
        editable: true,
        droppable: true
      });
      calendar.render();
    });

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const { data: { text } } = await Tesseract.recognize(file, 'eng');
      console.log('Texto OCR:', text);
      const materias = parseTable(text);
      renderMaterias(materias);
    });

    function parseTable(text) {
      const materias = [];
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);

      for (let line of lines) {
        const cols = line.split(/\s{2,}/); // dividir por 2+ espacios
        if (cols.length >= 6) {
          const codigo = cols[1] || '';
          const nombre = cols[2] || '';
          const creditos = cols[4] || '0';
          const profesor = cols[7] || '';
          const horariosTexto = cols[8] || '';

          const horarios = [...horariosTexto.matchAll(/(Mon|Tue|Wed|Thu|Fri)\((\d{2}:\d{2})-(\d{2}:\d{2})\)/g)]
            .map(h => ({ dia: h[1], horaInicio: h[2], horaFin: h[3] }));

          if (codigo && nombre && horarios.length > 0) {
            materias.push({ codigo, nombre, creditos, profesor, horarios });
          }
        }
      }
      return materias;
    }

    function renderMaterias(materias) {
      materiasList.innerHTML = '';
      materias.forEach(materia => {
        const div = document.createElement('div');
        div.className = 'materia';
        div.textContent = `${materia.codigo} - ${materia.nombre} (${materia.profesor})`;

        div.draggable = true;
        div.addEventListener('dragstart', e => {
          e.dataTransfer.setData('materia', JSON.stringify(materia));
        });

        materiasList.appendChild(div);
      });

      document.getElementById('calendar').addEventListener('dragover', e => e.preventDefault());
      document.getElementById('calendar').addEventListener('drop', e => {
        e.preventDefault();
        const materia = JSON.parse(e.dataTransfer.getData('materia'));

        materia.horarios.forEach(h => {
          const dayMap = { Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5 };
          const day = dayMap[h.dia];
          if (!day) return;

          const start = getDateForDay(day, h.horaInicio);
          const end = getDateForDay(day, h.horaFin);

          calendar.addEvent({
            title: `${materia.nombre} (${materia.profesor})`,
            start,
            end
          });
        });
      });
    }

    function getDateForDay(day, time) {
      const now = new Date();
      const currentDay = now.getDay();
      const diff = day - currentDay;
      const date = new Date(now);
      date.setDate(now.getDate() + diff);
      const [hours, minutes] = time.split(':').map(Number);
      date.setHours(hours, minutes, 0, 0);
      return date;
    }
  </script>
</body>
</html>