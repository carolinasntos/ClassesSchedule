<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Horario OCR - Materias</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      margin: 20px;
    }
    #subjects-panel {
      width: 300px;
      margin-right: 20px;
    }
    #subjects-list {
      border: 1px solid #ccc;
      min-height: 200px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .subject-block {
      background: #007bff;
      color: white;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
      cursor: grab;
    }
    #calendar {
      flex-grow: 1;
      max-width: 900px;
    }
  </style>
</head>
<body>
  <div id="subjects-panel">
    <h2>Materias detectadas</h2>
    <input type="file" id="imageInput" accept="image/*"><br><br>
    <div id="subjects-list"></div>
  </div>

  <div id="calendar"></div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'timeGridWeek',
      slotMinTime: "07:00:00",
      slotMaxTime: "21:00:00",
      editable: true,
      droppable: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'timeGridWeek,timeGridDay'
      }
    });
    calendar.render();

    document.getElementById('imageInput').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const { data: { text } } = await Tesseract.recognize(file, 'eng'); 
      console.log("Texto OCR detectado:", text);

      const materias = parseTable(text);
      renderSubjects(materias);
    });

    function parseTable(text) {
      const materias = [];
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // Ejemplo de formato esperado:
        // "CUL1120 Big data, IoT ... 3cr Thu(16:00-17:30) Thu(17:30-19:00) Prof: Kim Seong Hee"
        const match = line.match(/([A-Z]{2,}\d{3,})\s+(.+?)\s+(\d)cr\s+(.*?)\s+Prof:\s*(.+)/i);

        if (match) {
          const codigo = match[1];
          const nombre = match[2];
          const creditos = match[3];
          const horariosRaw = match[4];
          const profesor = match[5];

          // Buscar múltiples horarios: Ejemplo "Wed(14:30-16:00) Fri(10:30-12:00)"
          const horarios = [...horariosRaw.matchAll(/(Mon|Tue|Wed|Thu|Fri)\((\d{2}:\d{2})-(\d{2}:\d{2})\)/g)]
            .map(h => ({
              dia: h[1],
              horaInicio: h[2],
              horaFin: h[3]
            }));

          materias.push({ codigo, nombre, creditos, horarios, profesor });
        }
      }
      return materias;
    }

    function renderSubjects(materias) {
      const container = document.getElementById('subjects-list');
      container.innerHTML = '';

      materias.forEach(materia => {
        const div = document.createElement('div');
        div.className = 'subject-block';
        div.textContent = `${materia.codigo} ${materia.nombre}`;

        // Cada materia puede tener múltiples horarios → eventos múltiples
        div.dataset.events = JSON.stringify(
          materia.horarios.map(h => ({
            title: `${materia.nombre} - ${materia.profesor}`,
            daysOfWeek: [getDayNumber(h.dia)],
            startTime: h.horaInicio,
            endTime: h.horaFin
          }))
        );

        new FullCalendar.Draggable(div, {
          eventData: function() {
            return JSON.parse(div.dataset.events);
          }
        });

        container.appendChild(div);
      });
    }

    function getDayNumber(day) {
      const days = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 };
      return days[day] || 0;
    }
  </script>
</body>
</html>
