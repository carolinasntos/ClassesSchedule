<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calendario de Horarios</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
    }
    #calendar {
      max-width: 900px;
      margin: 2em auto;
    }
  </style>
</head>
<body>
  <h1>Horario Académico</h1>
  <p>Sube un archivo Excel con columnas: <strong>Materia</strong>, <strong>Día</strong>, <strong>Hora inicio</strong>, <strong>Hora fin</strong>.</p>
  <input type="file" id="fileInput" />
  <div id="calendar"></div>

  <!-- Librerías externas -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- Script principal -->
  <script>
    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'timeGridWeek',
      editable: true,
      selectable: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'timeGridWeek,timeGridDay'
      },
      events: [],
      select: function(info) {
        const title = prompt('Nombre de la materia:');
        if (title) {
          calendar.addEvent({
            title: title,
            start: info.start,
            end: info.end,
            allDay: false
          });
        }
        calendar.unselect();
      },
      eventClick: function(info) {
        if (confirm('¿Eliminar esta clase?')) {
          info.event.remove();
        }
      }
    });

    calendar.render();

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);

        const dayToIndex = {
          "Domingo": 0,
          "Lunes": 1,
          "Martes": 2,
          "Miércoles": 3,
          "Miercoles": 3,
          "Jueves": 4,
          "Viernes": 5,
          "Sábado": 6,
          "Sabado": 6
        };

        const baseDate = new Date();
        const currentWeekStart = new Date(baseDate.setDate(baseDate.getDate() - baseDate.getDay()));

        const parseHour = (date, timeStr) => {
          const [h, m] = timeStr.split(':').map(Number);
          const d = new Date(date);
          d.setHours(h);
          d.setMinutes(m);
          return d;
        };

        calendar.removeAllEvents();

        rows.forEach(row => {
          const day = dayToIndex[row["Día"]];
          if (day === undefined) return;

          const classDate = new Date(currentWeekStart);
          classDate.setDate(classDate.getDate() + day);

          const start = parseHour(classDate, row["Hora inicio"]);
          const end = parseHour(classDate, row["Hora fin"]);

          calendar.addEvent({
            title: row["Materia"],
            start: start.toISOString(),
            end: end.toISOString(),
            allDay: false
          });
        });
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
